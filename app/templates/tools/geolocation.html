{% extends "base.html" %}

{% block title %}Geolocation Tool - OpsToolKit{% endblock %}

{% block content %}
<div class="row">
    <div class="col-12">
        <!-- Page Header -->
        <div class="d-flex justify-content-between align-items-center mb-4">
            <div>
                <h2 class="mb-2">
                    <i class="bi bi-geo-alt-fill text-primary"></i>
                    Geolocation Tool
                </h2>
                <p class="text-muted mb-0">
                    Select countries to determine area attribution and format affected locations for reporting
                </p>
            </div>
            <a href="{{ url_for('landing.tools') }}" class="btn btn-outline-secondary">
                <i class="bi bi-arrow-left"></i> Back to Tools
            </a>
        </div>

        <!-- Info Alert -->
        {% if pre_selected %}
        <div class="alert alert-warning alert-dismissible fade show" role="alert">
            <i class="bi bi-pencil-square me-2"></i>
            <strong>Update Mode:</strong> You can add or remove countries from your previous selection below, then click "Locate & Generate Report" to see updated results.
            <button type="button" class="btn-close" data-bs-dismiss="alert" aria-label="Close"></button>
        </div>
        {% else %}
        <div class="alert alert-info alert-dismissible fade show" role="alert">
            <i class="bi bi-info-circle-fill me-2"></i>
            <strong>About this tool:</strong> Select one or more countries to generate standardized reporting language.
            The tool uses UN M49 regional standards to determine appropriate area attribution.
            <button type="button" class="btn-close" data-bs-dismiss="alert" aria-label="Close"></button>
        </div>
        {% endif %}

        <!-- Main Content Card -->
        <div class="card shadow-sm">
            <div class="card-body">
                <form method="POST" action="{{ url_for('geolocation.process') }}" id="geolocationForm" autocomplete="off">

                    <!-- Search Filter (moved to top for better UX) -->
                    <div class="mb-3">
                        <label for="searchCountry" class="form-label fw-bold">
                            <i class="bi bi-search me-2"></i>Search Countries
                        </label>
                        <input
                            type="text"
                            class="form-control form-control-lg"
                            id="searchCountry"
                            placeholder="Type to filter countries..."
                            autocomplete="off"
                        >
                        <div class="form-text">
                            <i class="bi bi-lightbulb me-1"></i>
                            Start typing to quickly find countries.
                            <span class="fw-bold" id="matchCount">{{ countries|length }} countries</span>
                        </div>
                    </div>

                    <!-- Selection Summary -->
                    <div class="alert alert-light border d-flex justify-content-between align-items-center mb-3">
                        <span>
                            <i class="bi bi-check2-square text-primary me-2"></i>
                            <strong id="selectionCount">0 countries selected</strong>
                        </span>
                        <div class="btn-group btn-group-sm" role="group">
                            <button type="button" class="btn btn-outline-primary" id="selectAllVisible">
                                <i class="bi bi-check-all"></i> Select All Visible
                            </button>
                            <button type="button" class="btn btn-outline-secondary" id="clearAll">
                                <i class="bi bi-x-circle"></i> Clear All
                            </button>
                        </div>
                    </div>

                    <!-- Country Checkboxes -->
                    <div class="mb-4">
                        <label class="form-label fw-bold">
                            <i class="bi bi-globe me-2"></i>Select Countries
                        </label>
                        <div
                            id="countryCheckboxes"
                            class="border rounded p-3 bg-light"
                            style="max-height: 400px; overflow-y: auto;"
                        >
                            {% for country in countries %}
                            <div class="form-check country-checkbox-item" data-country="{{ country|lower }}">
                                <input
                                    class="form-check-input country-checkbox"
                                    type="checkbox"
                                    name="countries"
                                    value="{{ country }}"
                                    id="country-{{ loop.index }}"
                                    {% if pre_selected and country in pre_selected %}checked{% endif %}
                                >
                                <label class="form-check-label" for="country-{{ loop.index }}">
                                    {{ country }}
                                </label>
                            </div>
                            {% endfor %}
                        </div>
                        <div id="noResults" class="text-center text-muted mt-3" style="display: none;">
                            <i class="bi bi-search"></i>
                            <p>No countries found matching your search.</p>
                        </div>
                    </div>

                    <!-- Submit Button -->
                    <div class="d-grid gap-2">
                        <button type="submit" class="btn btn-primary btn-lg" id="submitBtn" disabled>
                            <i class="bi bi-geo-fill me-2"></i>
                            Locate & Generate Report
                        </button>
                    </div>
                </form>
            </div>
        </div>

        <!-- Help Section -->
        <div class="card mt-4 border-secondary">
            <div class="card-header bg-secondary text-white">
                <i class="bi bi-question-circle-fill me-2"></i>How to Use
            </div>
            <div class="card-body">
                <h6 class="fw-bold">Area Attribution Logic:</h6>
                <ul class="mb-3">
                    <li><strong>Single country:</strong> Returns the country name</li>
                    <li><strong>Same region:</strong> Returns the region name (e.g., "Southern Asia")</li>
                    <li><strong>Same continent:</strong> Returns the continent name (e.g., "Europe")</li>
                    <li><strong>All continents:</strong> Returns "Worldwide"</li>
                    <li><strong>Multiple regions:</strong> Returns "Multiregional"</li>
                </ul>
                <hr>
                <h6 class="fw-bold mt-3">Affected Locations Formatting:</h6>
                <ul class="mb-0">
                    <li>1 country: "Canada"</li>
                    <li>2 countries: "Canada and USA"</li>
                    <li>3+ countries: "Canada, Mexico, and USA"</li>
                </ul>
            </div>
        </div>
    </div>
</div>
{% endblock %}

{% block extra_js %}
<script>
document.addEventListener('DOMContentLoaded', function() {
    const searchInput = document.getElementById('searchCountry');
    const countDisplay = document.getElementById('selectionCount');
    const matchCountDisplay = document.getElementById('matchCount');
    const selectAllVisibleBtn = document.getElementById('selectAllVisible');
    const clearAllBtn = document.getElementById('clearAll');
    const submitBtn = document.getElementById('submitBtn');
    const noResults = document.getElementById('noResults');
    const checkboxItems = document.querySelectorAll('.country-checkbox-item');
    const checkboxes = document.querySelectorAll('.country-checkbox');
    const totalCountries = checkboxItems.length;

    // Debug: Log pre-selected countries
    const preSelected = {{ pre_selected|tojson }};
    console.log('Pre-selected countries:', preSelected);

    // Debug: Count checked checkboxes on load
    const checkedOnLoad = Array.from(checkboxes).filter(cb => cb.checked).length;
    console.log('Checkboxes checked on page load:', checkedOnLoad);

    // Update selection count and button state
    function updateSelectionCount() {
        const checkedCount = Array.from(checkboxes).filter(cb => cb.checked).length;
        countDisplay.textContent = `${checkedCount} ${checkedCount === 1 ? 'country' : 'countries'} selected`;

        // Enable/disable submit button
        submitBtn.disabled = checkedCount === 0;

        // Update color
        if (checkedCount > 0) {
            countDisplay.parentElement.classList.remove('alert-light');
            countDisplay.parentElement.classList.add('alert-success');
        } else {
            countDisplay.parentElement.classList.remove('alert-success');
            countDisplay.parentElement.classList.add('alert-light');
        }
    }

    // Update match count for visible items
    function updateMatchCount() {
        const visibleCount = Array.from(checkboxItems).filter(item =>
            item.style.display !== 'none'
        ).length;

        matchCountDisplay.textContent = `${visibleCount} ${visibleCount === 1 ? 'country' : 'countries'}`;

        // Show/hide no results message
        if (visibleCount === 0 && searchInput.value.trim() !== '') {
            noResults.style.display = 'block';
        } else {
            noResults.style.display = 'none';
        }
    }

    // Search filter with debouncing for better performance
    let searchTimeout;
    searchInput.addEventListener('input', function() {
        clearTimeout(searchTimeout);
        searchTimeout = setTimeout(() => {
            const searchTerm = this.value.toLowerCase().trim();

            checkboxItems.forEach(item => {
                const countryName = item.getAttribute('data-country');
                const matches = countryName.includes(searchTerm);
                item.style.display = matches ? '' : 'none';
            });

            updateMatchCount();
        }, 150); // Debounce by 150ms for smoother typing
    });

    // Select all visible checkboxes
    selectAllVisibleBtn.addEventListener('click', function() {
        checkboxItems.forEach(item => {
            if (item.style.display !== 'none') {
                const checkbox = item.querySelector('.country-checkbox');
                checkbox.checked = true;
            }
        });
        updateSelectionCount();
    });

    // Clear all selections
    clearAllBtn.addEventListener('click', function() {
        checkboxes.forEach(checkbox => {
            checkbox.checked = false;
        });
        updateSelectionCount();
    });

    // Update count when any checkbox changes
    checkboxes.forEach(checkbox => {
        checkbox.addEventListener('change', updateSelectionCount);
    });

    // Only reset checkboxes if we're NOT in update mode (prevent browser caching for new selections)
    const hasPreSelected = Array.from(checkboxes).some(cb => cb.checked);
    console.log('Has pre-selected items:', hasPreSelected);

    if (!hasPreSelected && preSelected.length === 0) {
        // Only clear if truly no pre-selection (fresh page load)
        console.log('Clearing all checkboxes (fresh load)');
        checkboxes.forEach(checkbox => {
            checkbox.checked = false;
        });
    } else {
        console.log('Preserving pre-selected checkboxes');
    }

    // Auto-focus search input
    searchInput.focus();

    // Initial states
    updateSelectionCount();
    updateMatchCount();

    // Keyboard shortcuts
    document.addEventListener('keydown', function(e) {
        // Ctrl/Cmd + A to select all visible
        if ((e.ctrlKey || e.metaKey) && e.key === 'a' && searchInput !== document.activeElement) {
            e.preventDefault();
            selectAllVisibleBtn.click();
        }

        // Escape to clear search
        if (e.key === 'Escape' && searchInput === document.activeElement) {
            searchInput.value = '';
            searchInput.dispatchEvent(new Event('input'));
        }
    });
});
</script>

<style>
/* Smooth scrolling for checkbox container */
#countryCheckboxes {
    scroll-behavior: smooth;
}

/* Highlight matching text on hover */
.country-checkbox-item:hover {
    background-color: rgba(13, 110, 253, 0.1);
    transition: background-color 0.2s;
}

/* Checked items styling */
.country-checkbox:checked + label {
    font-weight: 600;
    color: #0d6efd;
}

/* Better checkbox styling */
.form-check {
    padding: 0.5rem;
    margin-bottom: 0.25rem;
    border-radius: 0.25rem;
}

/* Scrollbar styling for webkit browsers */
#countryCheckboxes::-webkit-scrollbar {
    width: 8px;
}

#countryCheckboxes::-webkit-scrollbar-track {
    background: #f1f1f1;
    border-radius: 4px;
}

#countryCheckboxes::-webkit-scrollbar-thumb {
    background: #888;
    border-radius: 4px;
}

#countryCheckboxes::-webkit-scrollbar-thumb:hover {
    background: #555;
}
</style>
{% endblock %}
