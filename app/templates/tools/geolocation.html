{% extends "base.html" %}

{% block title %}Geolocation Tool - OpsToolKit{% endblock %}

{% block content %}
<div class="row">
    <div class="col-12">
        <!-- Page Header -->
        <div class="d-flex justify-content-between align-items-center mb-4">
            <div>
                <h2 class="mb-2">
                    <i class="bi bi-geo-alt-fill text-primary"></i>
                    Geolocation Tool
                </h2>
                <p class="text-muted mb-0">
                    Extract GPS coordinates from images and visualize on an interactive map
                </p>
            </div>
            <a href="{{ url_for('landing.tools') }}" class="btn btn-outline-secondary">
                <i class="bi bi-arrow-left"></i> Back to Tools
            </a>
        </div>

        <!-- Info Alert -->
        <div class="alert alert-info" role="alert">
            <i class="bi bi-info-circle-fill"></i>
            <strong>Supported Formats:</strong> JPEG, PNG with EXIF GPS data |
            <strong>Max Files:</strong> 20 images |
            <strong>Max Size:</strong> {{ config.MAX_UPLOAD_SIZE_MB }} MB per file
        </div>

        <!-- Upload Form -->
        <div class="card shadow-sm">
            <div class="card-header bg-primary text-white">
                <h5 class="mb-0">
                    <i class="bi bi-upload"></i> Upload Images
                </h5>
            </div>
            <div class="card-body">
                <form method="POST"
                      action="{{ url_for('geolocation.upload') }}"
                      enctype="multipart/form-data"
                      id="upload-form"
                      data-loading="true"
                      data-loading-message="Extracting GPS data from images...">

                    <!-- File Upload Area -->
                    <div class="mb-4">
                        <label class="form-label fw-bold">
                            <i class="bi bi-file-image"></i> Select Images
                        </label>

                        <div class="file-upload-area" id="file-upload-area">
                            <input type="file"
                                   class="form-control"
                                   id="images"
                                   name="images"
                                   multiple
                                   accept=".jpg,.jpeg,.png"
                                   style="display: none;">

                            <div class="file-upload-icon">
                                <i class="bi bi-cloud-upload"></i>
                            </div>

                            <h5>Drag & Drop Images Here</h5>
                            <p class="text-muted mb-2">or click to browse</p>
                            <p>
                                <small class="text-muted">
                                    Accepts: JPEG, PNG • Max 20 files • {{ config.MAX_UPLOAD_SIZE_MB }} MB each
                                </small>
                            </p>
                        </div>

                        <!-- Selected Files List -->
                        <div id="selected-files" class="mt-3" style="display: none;">
                            <h6 class="fw-bold">Selected Files:</h6>
                            <ul id="files-list" class="list-group"></ul>
                        </div>
                    </div>

                    <!-- Map Options -->
                    <div class="card mb-4">
                        <div class="card-header">
                            <h6 class="mb-0">
                                <i class="bi bi-gear"></i> Map Options
                            </h6>
                        </div>
                        <div class="card-body">
                            <div class="row">
                                <!-- Tile Layer Selection -->
                                <div class="col-md-4 mb-3">
                                    <label for="tile_layer" class="form-label">
                                        <i class="bi bi-map"></i> Map Style
                                    </label>
                                    <select class="form-select" id="tile_layer" name="tile_layer">
                                        <option value="OpenStreetMap" selected>OpenStreetMap</option>
                                        <option value="Satellite">Satellite</option>
                                        <option value="Terrain">Terrain</option>
                                        <option value="CartoDB">CartoDB</option>
                                    </select>
                                </div>

                                <!-- Show Path Option -->
                                <div class="col-md-4 mb-3">
                                    <label class="form-label d-block">
                                        <i class="bi bi-bezier"></i> Display Options
                                    </label>
                                    <div class="form-check">
                                        <input class="form-check-input"
                                               type="checkbox"
                                               id="show_path"
                                               name="show_path">
                                        <label class="form-check-label" for="show_path">
                                            Connect locations with path (2+ images)
                                        </label>
                                    </div>
                                </div>

                                <!-- Cluster Markers Option -->
                                <div class="col-md-4 mb-3">
                                    <label class="form-label d-block">
                                        <i class="bi bi-bullseye"></i> Marker Options
                                    </label>
                                    <div class="form-check">
                                        <input class="form-check-input"
                                               type="checkbox"
                                               id="cluster_markers"
                                               name="cluster_markers">
                                        <label class="form-check-label" for="cluster_markers">
                                            Cluster nearby markers (5+ images)
                                        </label>
                                    </div>
                                </div>
                            </div>
                        </div>
                    </div>

                    <!-- Submit Button -->
                    <div class="d-grid gap-2">
                        <button type="submit" class="btn btn-primary btn-lg" id="submit-btn" disabled>
                            <i class="bi bi-arrow-right-circle"></i> Extract GPS Data & Generate Map
                        </button>
                    </div>
                </form>
            </div>
        </div>

        <!-- How It Works Section -->
        <div class="card mt-4 border-info">
            <div class="card-header bg-info text-white">
                <h5 class="mb-0">
                    <i class="bi bi-question-circle"></i> How It Works
                </h5>
            </div>
            <div class="card-body">
                <div class="row">
                    <div class="col-md-3">
                        <div class="text-center">
                            <i class="bi bi-file-image text-primary" style="font-size: 2rem;"></i>
                            <h6 class="mt-2 fw-bold">1. Upload Images</h6>
                            <p class="small text-muted">
                                Select one or more images with GPS metadata
                            </p>
                        </div>
                    </div>
                    <div class="col-md-3">
                        <div class="text-center">
                            <i class="bi bi-search text-success" style="font-size: 2rem;"></i>
                            <h6 class="mt-2 fw-bold">2. Extract EXIF</h6>
                            <p class="small text-muted">
                                System reads GPS coordinates from image metadata
                            </p>
                        </div>
                    </div>
                    <div class="col-md-3">
                        <div class="text-center">
                            <i class="bi bi-map text-warning" style="font-size: 2rem;"></i>
                            <h6 class="mt-2 fw-bold">3. Generate Map</h6>
                            <p class="small text-muted">
                                Interactive map created with location markers
                            </p>
                        </div>
                    </div>
                    <div class="col-md-3">
                        <div class="text-center">
                            <i class="bi bi-download text-info" style="font-size: 2rem;"></i>
                            <h6 class="mt-2 fw-bold">4. Export Data</h6>
                            <p class="small text-muted">
                                Download coordinates in JSON format
                            </p>
                        </div>
                    </div>
                </div>
            </div>
        </div>
    </div>
</div>
{% endblock %}

{% block extra_js %}
<script>
    // File upload handling
    (function() {
        const fileInput = document.getElementById('images');
        const uploadArea = document.getElementById('file-upload-area');
        const selectedFiles = document.getElementById('selected-files');
        const filesList = document.getElementById('files-list');
        const submitBtn = document.getElementById('submit-btn');

        // Update file list display
        function updateFilesList() {
            filesList.innerHTML = '';

            if (fileInput.files.length === 0) {
                selectedFiles.style.display = 'none';
                submitBtn.disabled = true;
                return;
            }

            selectedFiles.style.display = 'block';
            submitBtn.disabled = false;

            Array.from(fileInput.files).forEach((file, index) => {
                const li = document.createElement('li');
                li.className = 'list-group-item d-flex justify-content-between align-items-center';

                const fileInfo = document.createElement('div');
                fileInfo.innerHTML = `
                    <i class="bi bi-file-image text-primary"></i>
                    <strong>${file.name}</strong>
                    <small class="text-muted">(${(file.size / 1024).toFixed(1)} KB)</small>
                `;

                const removeBtn = document.createElement('button');
                removeBtn.className = 'btn btn-sm btn-outline-danger';
                removeBtn.type = 'button';
                removeBtn.innerHTML = '<i class="bi bi-x"></i>';
                removeBtn.onclick = () => removeFile(index);

                li.appendChild(fileInfo);
                li.appendChild(removeBtn);
                filesList.appendChild(li);
            });
        }

        // Remove file from selection
        function removeFile(index) {
            const dt = new DataTransfer();
            Array.from(fileInput.files).forEach((file, i) => {
                if (i !== index) dt.items.add(file);
            });
            fileInput.files = dt.files;
            updateFilesList();
        }

        // File input change handler
        fileInput.addEventListener('change', updateFilesList);

        // File upload area is already handled by main.js
        // Just connect it to our specific input
        uploadArea.addEventListener('click', () => fileInput.click());
    })();
</script>
{% endblock %}
