{% extends "base.html" %}

{% block title %}DR-Tracker Builder - OpsToolKit{% endblock %}

{% block content %}
<div class="row">
    <div class="col-12">
        <!-- Page Header -->
        <div class="d-flex justify-content-between align-items-center mb-4">
            <div>
                <h2 class="mb-2">
                    <i class="bi bi-table text-warning"></i>
                    DR-Tracker Builder
                </h2>
                <p class="text-muted mb-0">
                    Generate structured DR-Tracker reports from text descriptions
                </p>
            </div>
            <a href="{{ url_for('landing.tools') }}" class="btn btn-outline-secondary">
                <i class="bi bi-arrow-left"></i> Back to Tools
            </a>
        </div>

        <!-- Info Alert -->
        <div class="alert alert-info" role="alert">
            <i class="bi bi-info-circle-fill"></i>
            <strong>AI-Powered Generation</strong> |
            Converts natural language to structured DR entries |
            Export to CSV, JSON, or XLSX |
            <strong>Timeout:</strong> {{ config.DR_TRACKER_TIMEOUT_SECONDS }} seconds
        </div>

        <!-- Input Form -->
        <div class="card shadow-sm">
            <div class="card-header bg-warning text-dark">
                <h5 class="mb-0">
                    <i class="bi bi-pencil-square"></i> Describe DR Entries
                </h5>
            </div>
            <div class="card-body">
                <form method="POST"
                      action="{{ url_for('dr_tracker.generate') }}"
                      id="dr-form"
                      data-loading="true"
                      data-loading-message="AI is generating your DR entries...">

                    <!-- Prompt Input -->
                    <div class="mb-4">
                        <label for="prompt" class="form-label fw-bold">
                            <i class="bi bi-chat-left-text"></i> DR Description
                        </label>
                        <textarea class="form-control font-monospace"
                                  id="prompt"
                                  name="prompt"
                                  rows="10"
                                  placeholder="Describe the discrepancy reports you want to create...

Example 1 (Multiple DRs):
Create 3 DR entries:
1. Critical issue with server cooling system in datacenter A, needs immediate attention
2. Medium priority documentation error in API guide, assigned to tech writing team
3. Low priority cosmetic UI issue in dashboard

Example 2 (Detailed Single DR):
Create a high-priority DR for the network outage that occurred on Dec 15th. The main router failed causing 2 hours of downtime. This affected all users and needs to be resolved by the infrastructure team within 5 days.

Example 3 (Safety Issue):
Generate a safety DR for the wet floor in building B hallway. This is a high priority safety hazard that needs immediate resolution. Assign to facilities team."
                                  style="resize: vertical;"
                                  required></textarea>
                        <div class="form-text">
                            Character count: <span id="char-count">0</span> |
                            Maximum: 10,000 characters
                        </div>
                    </div>

                    <!-- Submit Button -->
                    <div class="d-grid gap-2">
                        <button type="submit" class="btn btn-warning btn-lg text-dark fw-bold" id="submit-btn">
                            <i class="bi bi-robot"></i> Generate DR Entries with AI
                        </button>
                    </div>
                </form>
            </div>
        </div>

        <!-- DR Field Explanation -->
        <div class="card mt-4 border-warning">
            <div class="card-header bg-warning text-dark">
                <h5 class="mb-0">
                    <i class="bi bi-list-check"></i> DR Entry Fields
                </h5>
            </div>
            <div class="card-body">
                <div class="row">
                    <div class="col-md-6">
                        <h6 class="fw-bold text-warning">
                            <i class="bi bi-check-circle"></i> Required Fields
                        </h6>
                        <ul class="small">
                            <li><strong>ID:</strong> Unique identifier (DR-001, DR-002, etc.)</li>
                            <li><strong>Title:</strong> Brief, descriptive title</li>
                            <li><strong>Description:</strong> Detailed issue description</li>
                            <li><strong>Category:</strong> Technical, Process, Safety, Documentation, Quality, Other</li>
                            <li><strong>Priority:</strong> High, Medium, or Low</li>
                        </ul>
                    </div>
                    <div class="col-md-6">
                        <h6 class="fw-bold text-warning">
                            <i class="bi bi-info-circle"></i> Optional Fields
                        </h6>
                        <ul class="small">
                            <li><strong>Status:</strong> Open, In Progress, Resolved, Closed</li>
                            <li><strong>Assigned To:</strong> Person or team responsible</li>
                            <li><strong>Created Date:</strong> When the DR was created</li>
                            <li><strong>Due Date:</strong> Expected resolution date</li>
                            <li><strong>Resolution:</strong> How it was resolved (if applicable)</li>
                        </ul>
                    </div>
                </div>
            </div>
        </div>

        <!-- Example Prompts -->
        <div class="card mt-4 border-info">
            <div class="card-header bg-info text-white">
                <h5 class="mb-0">
                    <i class="bi bi-lightbulb"></i> Example Prompts
                </h5>
            </div>
            <div class="card-body">
                <div class="accordion" id="examplesAccordion">
                    <!-- Example 1 -->
                    <div class="accordion-item">
                        <h2 class="accordion-header">
                            <button class="accordion-button collapsed" type="button"
                                    data-bs-toggle="collapse" data-bs-target="#example1">
                                <i class="bi bi-1-circle text-primary me-2"></i>
                                Multiple Safety Issues
                            </button>
                        </h2>
                        <div id="example1" class="accordion-collapse collapse" data-bs-parent="#examplesAccordion">
                            <div class="accordion-body">
                                <code class="d-block p-2 bg-light">
Create 3 safety DRs:
1. Broken emergency exit light in Building A, 2nd floor - High priority
2. Missing fire extinguisher in Lab 3 - High priority
3. Cracked window pane in Office 205 - Medium priority

All should be assigned to the Facilities team and need resolution within 7 days.
                                </code>
                                <button class="btn btn-sm btn-outline-primary mt-2"
                                        onclick="useExample(this.previousElementSibling.textContent.trim())">
                                    <i class="bi bi-arrow-up-circle"></i> Use This Example
                                </button>
                            </div>
                        </div>
                    </div>

                    <!-- Example 2 -->
                    <div class="accordion-item">
                        <h2 class="accordion-header">
                            <button class="accordion-button collapsed" type="button"
                                    data-bs-toggle="collapse" data-bs-target="#example2">
                                <i class="bi bi-2-circle text-success me-2"></i>
                                Technical Issue
                            </button>
                        </h2>
                        <div id="example2" class="accordion-collapse collapse" data-bs-parent="#examplesAccordion">
                            <div class="accordion-body">
                                <code class="d-block p-2 bg-light">
Create a high-priority technical DR for the database performance issue.
The main production database is experiencing slow query times (>5 seconds)
affecting user experience. This started on Dec 10th and needs immediate
investigation by the Database team. Target resolution within 3 days.
                                </code>
                                <button class="btn btn-sm btn-outline-success mt-2"
                                        onclick="useExample(this.previousElementSibling.textContent.trim())">
                                    <i class="bi bi-arrow-up-circle"></i> Use This Example
                                </button>
                            </div>
                        </div>
                    </div>

                    <!-- Example 3 -->
                    <div class="accordion-item">
                        <h2 class="accordion-header">
                            <button class="accordion-button collapsed" type="button"
                                    data-bs-toggle="collapse" data-bs-target="#example3">
                                <i class="bi bi-3-circle text-warning me-2"></i>
                                Documentation Updates
                            </button>
                        </h2>
                        <div id="example3" class="accordion-collapse collapse" data-bs-parent="#examplesAccordion">
                            <div class="accordion-body">
                                <code class="d-block p-2 bg-light">
Generate 2 documentation DRs:
1. API documentation is outdated - missing endpoints added in v2.5 release
2. User manual has incorrect screenshots from old UI

Both are medium priority and should be assigned to the Technical Writing team.
                                </code>
                                <button class="btn btn-sm btn-outline-warning mt-2"
                                        onclick="useExample(this.previousElementSibling.textContent.trim())">
                                    <i class="bi bi-arrow-up-circle"></i> Use This Example
                                </button>
                            </div>
                        </div>
                    </div>
                </div>
            </div>
        </div>

        <!-- How It Works -->
        <div class="card mt-4">
            <div class="card-header">
                <h5 class="mb-0">
                    <i class="bi bi-gear"></i> How It Works
                </h5>
            </div>
            <div class="card-body">
                <div class="row text-center">
                    <div class="col-md-3">
                        <i class="bi bi-pencil-square text-warning" style="font-size: 2rem;"></i>
                        <h6 class="mt-2 fw-bold">1. Describe DRs</h6>
                        <p class="small text-muted">Write natural language description of discrepancies</p>
                    </div>
                    <div class="col-md-3">
                        <i class="bi bi-robot text-primary" style="font-size: 2rem;"></i>
                        <h6 class="mt-2 fw-bold">2. AI Processing</h6>
                        <p class="small text-muted">GPT-4 extracts structured data from your description</p>
                    </div>
                    <div class="col-md-3">
                        <i class="bi bi-table text-success" style="font-size: 2rem;"></i>
                        <h6 class="mt-2 fw-bold">3. Review Entries</h6>
                        <p class="small text-muted">Preview generated DR entries in table format</p>
                    </div>
                    <div class="col-md-3">
                        <i class="bi bi-download text-info" style="font-size: 2rem;"></i>
                        <h6 class="mt-2 fw-bold">4. Export Data</h6>
                        <p class="small text-muted">Download as CSV, JSON, or XLSX</p>
                    </div>
                </div>
            </div>
        </div>
    </div>
</div>
{% endblock %}

{% block extra_js %}
<script>
    // Character counting
    (function() {
        const textarea = document.getElementById('prompt');
        const charCount = document.getElementById('char-count');

        function updateCount() {
            charCount.textContent = textarea.value.length.toLocaleString();

            // Warn if approaching limit
            if (textarea.value.length > 9000) {
                charCount.parentElement.classList.add('text-warning');
            } else {
                charCount.parentElement.classList.remove('text-warning');
            }

            if (textarea.value.length > 10000) {
                charCount.parentElement.classList.add('text-danger');
                charCount.parentElement.classList.remove('text-warning');
            }
        }

        textarea.addEventListener('input', updateCount);
        updateCount();
    })();

    // Use example function
    function useExample(text) {
        document.getElementById('prompt').value = text;
        document.getElementById('prompt').dispatchEvent(new Event('input'));

        // Scroll to textarea
        document.getElementById('prompt').scrollIntoView({ behavior: 'smooth', block: 'center' });

        // Show success message
        OpsToolKit.showNotification('Example loaded! You can edit it before generating.', 'success', 3000);
    }
</script>
{% endblock %}
