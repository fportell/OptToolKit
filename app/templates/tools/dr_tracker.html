{% extends "base.html" %}

{% block title %}DR-Tracker Builder - OpsToolKit{% endblock %}

{% block content %}
<div class="row">
    <div class="col-12">
        <!-- Page Header -->
        <div class="d-flex justify-content-between align-items-center mb-4">
            <div>
                <h2 class="mb-2">
                    <i class="bi bi-table text-warning"></i>
                    DR-Tracker Builder
                </h2>
                <p class="text-muted mb-0">
                    Upload Daily Report HTML file to generate structured tracker
                </p>
            </div>
            <a href="{{ url_for('landing.tools') }}" class="btn btn-outline-secondary">
                <i class="bi bi-arrow-left"></i> Back to Tools
            </a>
        </div>

        <!-- Info Alert -->
        <div class="alert alert-info" role="alert">
            <i class="bi bi-info-circle-fill"></i>
            <strong>Daily Report Processing</strong> |
            Upload HTML file → AI extracts data → Match hazards → Edit entries → Export Excel (.xlsm)
        </div>

        <!-- Upload Form Card -->
        <div class="card shadow-sm">
            <div class="card-header bg-warning text-dark">
                <h5 class="mb-0">
                    <i class="bi bi-cloud-upload"></i> Upload HTML File
                </h5>
            </div>
            <div class="card-body">
                <form id="uploadForm" enctype="multipart/form-data">
                    <!-- File Input -->
                    <div class="mb-4">
                        <label for="htmlFile" class="form-label fw-bold">
                            <i class="bi bi-file-earmark-code"></i> Daily Report HTML File
                        </label>
                        <input
                            type="file"
                            class="form-control form-control-lg"
                            id="htmlFile"
                            name="html_file"
                            accept=".html,.htm"
                            required
                        >
                        <div class="form-text">
                            <i class="bi bi-info-circle"></i>
                            Accepted formats: .html, .htm | Maximum size: 5MB
                        </div>
                    </div>

                    <!-- File Info Display -->
                    <div id="fileInfo" class="alert alert-light border mb-4" style="display: none;">
                        <div class="d-flex align-items-center">
                            <i class="bi bi-file-earmark-check text-success me-3" style="font-size: 1.5rem;"></i>
                            <div>
                                <strong id="fileName"></strong><br>
                                <small class="text-muted"><span id="fileSize"></span></small>
                            </div>
                        </div>
                    </div>

                    <!-- Submit Button -->
                    <div class="d-grid gap-2">
                        <button type="submit" class="btn btn-warning btn-lg text-dark fw-bold" id="submitBtn">
                            <i class="bi bi-play-circle"></i> Process Daily Report
                        </button>
                    </div>
                </form>

                <!-- Processing Status (Hidden by default) -->
                <div id="processingStatus" class="mt-4" style="display: none;">
                    <div class="card border-primary">
                        <div class="card-body text-center">
                            <div class="spinner-border text-primary mb-3" role="status">
                                <span class="visually-hidden">Loading...</span>
                            </div>
                            <h5 class="card-title" id="statusText">Sanitizing HTML...</h5>
                            <p class="card-text text-muted">Please wait while we process your file</p>
                            <div class="progress mt-3" style="height: 25px;">
                                <div class="progress-bar progress-bar-striped progress-bar-animated"
                                     role="progressbar"
                                     id="progressBar"
                                     style="width: 0%">0%</div>
                            </div>
                        </div>
                    </div>
                </div>
            </div>
        </div>

        <!-- How It Works -->
        <div class="card mt-4">
            <div class="card-header">
                <h5 class="mb-0">
                    <i class="bi bi-gear"></i> How It Works
                </h5>
            </div>
            <div class="card-body">
                <div class="row text-center">
                    <div class="col-md-3">
                        <i class="bi bi-cloud-upload text-primary" style="font-size: 2rem;"></i>
                        <h6 class="mt-2 fw-bold">1. Upload HTML</h6>
                        <p class="small text-muted">Upload Daily Report HTML file from your computer</p>
                    </div>
                    <div class="col-md-3">
                        <i class="bi bi-robot text-warning" style="font-size: 2rem;"></i>
                        <h6 class="mt-2 fw-bold">2. AI Processing</h6>
                        <p class="small text-muted">GPT-4.1 extracts structured data from HTML</p>
                    </div>
                    <div class="col-md-3">
                        <i class="bi bi-pencil-square text-success" style="font-size: 2rem;"></i>
                        <h6 class="mt-2 fw-bold">3. Edit Entries</h6>
                        <p class="small text-muted">Review and edit extracted entries with searchable dropdowns</p>
                    </div>
                    <div class="col-md-3">
                        <i class="bi bi-download text-info" style="font-size: 2rem;"></i>
                        <h6 class="mt-2 fw-bold">4. Export Excel</h6>
                        <p class="small text-muted">Download .xlsm file with VBA macros</p>
                    </div>
                </div>
            </div>
        </div>

        <!-- Requirements Card -->
        <div class="card mt-4 border-info">
            <div class="card-header bg-info text-white">
                <h5 class="mb-0">
                    <i class="bi bi-list-check"></i> File Requirements
                </h5>
            </div>
            <div class="card-body">
                <ul class="mb-0">
                    <li><strong>Format:</strong> HTML file from Daily Report email (.html or .htm)</li>
                    <li><strong>Size:</strong> Maximum 5MB</li>
                    <li><strong>Content:</strong> Must contain structured Daily Report sections (HOD, DME, INT, RPG)</li>
                    <li><strong>Processing Time:</strong> Approximately 30-60 seconds depending on file size</li>
                    <li><strong>Hazard Matching:</strong> Automatically matches hazards to canonical list (exact + fuzzy matching)</li>
                </ul>
            </div>
        </div>
    </div>
</div>
{% endblock %}

{% block extra_js %}
<script>
    (function() {
        const form = document.getElementById('uploadForm');
        const fileInput = document.getElementById('htmlFile');
        const fileInfo = document.getElementById('fileInfo');
        const fileName = document.getElementById('fileName');
        const fileSize = document.getElementById('fileSize');
        const submitBtn = document.getElementById('submitBtn');
        const processingStatus = document.getElementById('processingStatus');
        const statusText = document.getElementById('statusText');
        const progressBar = document.getElementById('progressBar');

        // File selection handler
        fileInput.addEventListener('change', function() {
            if (this.files && this.files[0]) {
                const file = this.files[0];

                // Display file info
                fileName.textContent = file.name;
                const sizeKB = (file.size / 1024).toFixed(2);
                const sizeMB = (file.size / (1024 * 1024)).toFixed(2);
                fileSize.textContent = file.size < 1024 * 1024
                    ? `${sizeKB} KB`
                    : `${sizeMB} MB`;

                fileInfo.style.display = 'block';

                // Validate file size
                const maxSize = 5 * 1024 * 1024; // 5MB
                if (file.size > maxSize) {
                    OpsToolKit.showNotification('File is too large. Maximum size is 5MB.', 'danger', 5000);
                    this.value = '';
                    fileInfo.style.display = 'none';
                    return;
                }

                // Validate file type
                if (!file.name.toLowerCase().endsWith('.html') && !file.name.toLowerCase().endsWith('.htm')) {
                    OpsToolKit.showNotification('Invalid file type. Please upload .html or .htm file.', 'danger', 5000);
                    this.value = '';
                    fileInfo.style.display = 'none';
                    return;
                }
            }
        });

        // Form submission handler
        form.addEventListener('submit', async function(e) {
            e.preventDefault();

            const file = fileInput.files[0];
            if (!file) {
                OpsToolKit.showNotification('Please select a file to upload.', 'warning', 3000);
                return;
            }

            // Disable form
            submitBtn.disabled = true;
            fileInput.disabled = true;

            // Show processing status
            processingStatus.style.display = 'block';
            processingStatus.scrollIntoView({ behavior: 'smooth', block: 'center' });

            // Progress simulation
            let progress = 0;
            const progressInterval = setInterval(() => {
                progress += 1;
                if (progress <= 95) {
                    progressBar.style.width = progress + '%';
                    progressBar.textContent = progress + '%';
                }
            }, 800);

            // Status messages
            const statusMessages = [
                { time: 0, text: 'Sanitizing HTML...' },
                { time: 3000, text: 'Extracting data with AI (GPT-4.1)...' },
                { time: 10000, text: 'Matching hazards to canonical list...' },
                { time: 15000, text: 'Finalizing entries...' }
            ];

            statusMessages.forEach(msg => {
                setTimeout(() => {
                    statusText.textContent = msg.text;
                }, msg.time);
            });

            try {
                // Create form data
                const formData = new FormData();
                formData.append('html_file', file);

                // Submit to backend
                const response = await fetch('{{ url_for("dr_tracker.process") }}', {
                    method: 'POST',
                    body: formData
                });

                const result = await response.json();

                // Clear progress interval
                clearInterval(progressInterval);
                progressBar.style.width = '100%';
                progressBar.textContent = '100%';

                if (result.success) {
                    // Success
                    statusText.textContent = 'Processing complete!';
                    OpsToolKit.showNotification(
                        `Successfully processed ${result.entry_count} entries in ${result.processing_time.toFixed(1)}s`,
                        'success',
                        3000
                    );

                    // Redirect to editor
                    setTimeout(() => {
                        window.location.href = `/tools/dr-tracker/edit/${result.session_id}`;
                    }, 1000);
                } else {
                    // Error
                    clearInterval(progressInterval);
                    statusText.textContent = 'Processing failed';
                    progressBar.classList.remove('progress-bar-animated');
                    progressBar.classList.add('bg-danger');

                    OpsToolKit.showNotification(
                        `Error: ${result.error}`,
                        'danger',
                        8000
                    );

                    // Re-enable form
                    setTimeout(() => {
                        submitBtn.disabled = false;
                        fileInput.disabled = false;
                        processingStatus.style.display = 'none';
                        progressBar.style.width = '0%';
                        progressBar.classList.add('progress-bar-animated');
                        progressBar.classList.remove('bg-danger');
                    }, 3000);
                }
            } catch (error) {
                // Network or other error
                clearInterval(progressInterval);
                console.error('Error:', error);

                statusText.textContent = 'Upload failed';
                progressBar.classList.remove('progress-bar-animated');
                progressBar.classList.add('bg-danger');

                OpsToolKit.showNotification(
                    `Upload error: ${error.message}`,
                    'danger',
                    8000
                );

                // Re-enable form
                setTimeout(() => {
                    submitBtn.disabled = false;
                    fileInput.disabled = false;
                    processingStatus.style.display = 'none';
                    progressBar.style.width = '0%';
                    progressBar.classList.add('progress-bar-animated');
                    progressBar.classList.remove('bg-danger');
                }, 3000);
            }
        });
    })();
</script>
{% endblock %}
