{% extends "base.html" %}

{% block title %}DR Knowledge Chatbot - OpsToolKit{% endblock %}

{% block content %}
<div class="row">
    <div class="col-12">
        <!-- Page Header -->
        <div class="d-flex justify-content-between align-items-center mb-4">
            <div>
                <h2 class="mb-2">
                    <i class="bi bi-chat-dots text-info"></i>
                    DR Knowledge Chatbot
                </h2>
                <p class="text-muted mb-0">
                    Ask questions about the DR database in natural language
                </p>
            </div>
            <a href="{{ url_for('landing.tools') }}" class="btn btn-outline-secondary">
                <i class="bi bi-arrow-left"></i> Back to Tools
            </a>
        </div>

        <!-- Knowledge Base Info -->
        <div class="alert alert-{% if stats.loaded %}success{% else %}warning{% endif %}" role="alert">
            <div class="d-flex justify-content-between align-items-center">
                <div>
                    <i class="bi bi-{% if stats.loaded %}check-circle-fill{% else %}exclamation-triangle-fill{% endif %}"></i>
                    <strong>Knowledge Base:</strong>
                    {% if stats.loaded %}
                        Loaded with {{ stats.document_count }} documents |
                        Model: {{ stats.model_name }} |
                        Embeddings: {{ stats.embedding_dimension }}D
                    {% else %}
                        Not loaded - responses will be general only
                    {% endif %}
                </div>
                <button class="btn btn-sm btn-outline-danger" onclick="clearChat()">
                    <i class="bi bi-trash"></i> Clear History
                </button>
            </div>
        </div>

        <!-- Chat Interface -->
        <div class="card shadow-sm">
            <div class="card-header bg-info text-white">
                <h5 class="mb-0">
                    <i class="bi bi-chat-left-dots"></i> Chat Interface
                </h5>
            </div>
            <div class="card-body p-0">
                <!-- Chat Messages Container -->
                <div id="chat-container" class="p-3" style="height: 500px; overflow-y: auto; background: #f8f9fa;">
                    <!-- Welcome Message -->
                    <div class="message-bot mb-3">
                        <div class="d-flex align-items-start">
                            <div class="avatar bg-info text-white rounded-circle me-2 d-flex align-items-center justify-content-center"
                                 style="width: 36px; height: 36px; min-width: 36px;">
                                <i class="bi bi-robot"></i>
                            </div>
                            <div class="message-content bg-white p-3 rounded shadow-sm" style="max-width: 80%;">
                                <p class="mb-1">
                                    <strong>DR Knowledge Assistant</strong>
                                    <small class="text-muted">â€¢ Just now</small>
                                </p>
                                <p class="mb-0">
                                    Hello! I'm your DR knowledge assistant. I can help you find information from the
                                    DR database using natural language queries. Ask me anything about discrepancy reports,
                                    technical issues, or related topics.
                                </p>
                                {% if stats.loaded %}
                                <p class="mb-0 mt-2">
                                    <small class="text-muted">
                                        <i class="bi bi-info-circle"></i>
                                        I have access to {{ stats.document_count }} documents from the knowledge base.
                                    </small>
                                </p>
                                {% endif %}
                            </div>
                        </div>
                    </div>

                    <!-- Previous Messages from History -->
                    {% for msg in history %}
                    {% if msg.role == 'user' %}
                    <div class="message-user mb-3">
                        <div class="d-flex align-items-start justify-content-end">
                            <div class="message-content bg-primary text-white p-3 rounded shadow-sm" style="max-width: 80%;">
                                <p class="mb-0">{{ msg.content }}</p>
                            </div>
                            <div class="avatar bg-secondary text-white rounded-circle ms-2 d-flex align-items-center justify-content-center"
                                 style="width: 36px; height: 36px; min-width: 36px;">
                                <i class="bi bi-person"></i>
                            </div>
                        </div>
                    </div>
                    {% elif msg.role == 'assistant' %}
                    <div class="message-bot mb-3">
                        <div class="d-flex align-items-start">
                            <div class="avatar bg-info text-white rounded-circle me-2 d-flex align-items-center justify-content-center"
                                 style="width: 36px; height: 36px; min-width: 36px;">
                                <i class="bi bi-robot"></i>
                            </div>
                            <div class="message-content bg-white p-3 rounded shadow-sm" style="max-width: 80%;">
                                <p class="mb-0">{{ msg.content }}</p>
                            </div>
                        </div>
                    </div>
                    {% endif %}
                    {% endfor %}

                    <!-- Messages will be added here dynamically -->
                    <div id="messages"></div>

                    <!-- Typing indicator (hidden by default) -->
                    <div id="typing-indicator" class="message-bot mb-3" style="display: none;">
                        <div class="d-flex align-items-start">
                            <div class="avatar bg-info text-white rounded-circle me-2 d-flex align-items-center justify-content-center"
                                 style="width: 36px; height: 36px; min-width: 36px;">
                                <i class="bi bi-robot"></i>
                            </div>
                            <div class="message-content bg-white p-3 rounded shadow-sm">
                                <div class="typing-animation">
                                    <span></span>
                                    <span></span>
                                    <span></span>
                                </div>
                            </div>
                        </div>
                    </div>
                </div>

                <!-- Message Input -->
                <div class="card-footer bg-white border-top">
                    <form id="chat-form" onsubmit="sendMessage(event)">
                        <div class="input-group">
                            <input type="text"
                                   class="form-control"
                                   id="message-input"
                                   placeholder="Type your question here..."
                                   maxlength="1000"
                                   required
                                   autofocus>
                            <button type="submit" class="btn btn-info" id="send-btn">
                                <i class="bi bi-send-fill"></i> Send
                            </button>
                        </div>
                        <div class="form-text">
                            Press Enter to send | Maximum 1000 characters
                        </div>
                    </form>
                </div>
            </div>
        </div>

        <!-- Quick Examples -->
        <div class="card mt-4 border-info">
            <div class="card-header bg-info text-white">
                <h6 class="mb-0">
                    <i class="bi bi-lightbulb"></i> Example Questions
                </h6>
            </div>
            <div class="card-body">
                <div class="row">
                    <div class="col-md-6 mb-2">
                        <button class="btn btn-sm btn-outline-info w-100 text-start"
                                onclick="askQuestion('What are the most common types of DRs?')">
                            <i class="bi bi-chat-quote"></i> What are the most common types of DRs?
                        </button>
                    </div>
                    <div class="col-md-6 mb-2">
                        <button class="btn btn-sm btn-outline-info w-100 text-start"
                                onclick="askQuestion('Show me high priority safety issues')">
                            <i class="bi bi-chat-quote"></i> Show me high priority safety issues
                        </button>
                    </div>
                    <div class="col-md-6 mb-2">
                        <button class="btn btn-sm btn-outline-info w-100 text-start"
                                onclick="askQuestion('What DRs are assigned to the infrastructure team?')">
                            <i class="bi bi-chat-quote"></i> What DRs are assigned to the infrastructure team?
                        </button>
                    </div>
                    <div class="col-md-6 mb-2">
                        <button class="btn btn-sm btn-outline-info w-100 text-start"
                                onclick="askQuestion('Summarize recent technical issues')">
                            <i class="bi bi-chat-quote"></i> Summarize recent technical issues
                        </button>
                    </div>
                </div>
            </div>
        </div>
    </div>
</div>
{% endblock %}

{% block extra_css %}
<style>
    /* Typing animation */
    .typing-animation {
        display: flex;
        align-items: center;
        gap: 4px;
    }

    .typing-animation span {
        width: 8px;
        height: 8px;
        border-radius: 50%;
        background: #0dcaf0;
        animation: typing 1.4s infinite;
    }

    .typing-animation span:nth-child(2) {
        animation-delay: 0.2s;
    }

    .typing-animation span:nth-child(3) {
        animation-delay: 0.4s;
    }

    @keyframes typing {
        0%, 60%, 100% {
            transform: translateY(0);
            opacity: 0.7;
        }
        30% {
            transform: translateY(-10px);
            opacity: 1;
        }
    }

    /* Chat container scrollbar */
    #chat-container {
        scrollbar-width: thin;
        scrollbar-color: #6c757d #f8f9fa;
    }

    #chat-container::-webkit-scrollbar {
        width: 8px;
    }

    #chat-container::-webkit-scrollbar-track {
        background: #f8f9fa;
    }

    #chat-container::-webkit-scrollbar-thumb {
        background: #6c757d;
        border-radius: 4px;
    }

    /* Message animations */
    .message-user, .message-bot {
        animation: slideIn 0.3s ease-out;
    }

    @keyframes slideIn {
        from {
            opacity: 0;
            transform: translateY(10px);
        }
        to {
            opacity: 1;
            transform: translateY(0);
        }
    }

    /* Context badge styling */
    .context-badge {
        font-size: 0.75rem;
        padding: 0.25rem 0.5rem;
    }
</style>
{% endblock %}

{% block extra_js %}
<script>
    // Send message function
    async function sendMessage(event) {
        event.preventDefault();

        const input = document.getElementById('message-input');
        const message = input.value.trim();

        if (!message) return;

        // Disable input while processing
        input.disabled = true;
        document.getElementById('send-btn').disabled = true;

        // Add user message to chat
        addUserMessage(message);

        // Clear input
        input.value = '';

        // Show typing indicator
        document.getElementById('typing-indicator').style.display = 'block';
        scrollToBottom();

        try {
            // Send to backend
            const response = await fetch('{{ url_for("chatbot.send_message") }}', {
                method: 'POST',
                headers: {
                    'Content-Type': 'application/json',
                },
                body: JSON.stringify({ message: message })
            });

            const data = await response.json();

            // Hide typing indicator
            document.getElementById('typing-indicator').style.display = 'none';

            if (response.ok) {
                // Add bot response
                addBotMessage(data.response, data.context, data.processing_time);
            } else {
                // Show error
                addBotMessage(`Error: ${data.error || 'Unknown error occurred'}`, null, null, true);
            }

        } catch (error) {
            console.error('Error sending message:', error);
            document.getElementById('typing-indicator').style.display = 'none';
            addBotMessage('Network error. Please check your connection and try again.', null, null, true);
        } finally {
            // Re-enable input
            input.disabled = false;
            document.getElementById('send-btn').disabled = false;
            input.focus();
        }
    }

    // Add user message to chat
    function addUserMessage(text) {
        const container = document.getElementById('messages');

        const messageDiv = document.createElement('div');
        messageDiv.className = 'message-user mb-3';
        messageDiv.innerHTML = `
            <div class="d-flex align-items-start justify-content-end">
                <div class="message-content bg-primary text-white p-3 rounded shadow-sm" style="max-width: 80%;">
                    <p class="mb-0">${escapeHtml(text)}</p>
                </div>
                <div class="avatar bg-secondary text-white rounded-circle ms-2 d-flex align-items-center justify-content-center"
                     style="width: 36px; height: 36px; min-width: 36px;">
                    <i class="bi bi-person"></i>
                </div>
            </div>
        `;

        container.appendChild(messageDiv);
        scrollToBottom();
    }

    // Add bot message to chat
    function addBotMessage(text, context, processingTime, isError = false) {
        const container = document.getElementById('messages');

        const messageDiv = document.createElement('div');
        messageDiv.className = 'message-bot mb-3';

        let contextHtml = '';
        if (context && context.length > 0) {
            contextHtml = '<div class="mt-2"><small class="text-muted"><i class="bi bi-database"></i> Context sources: ';
            contextHtml += context.map((c, i) => `<span class="badge bg-info context-badge">Source ${i+1} (${(c.score * 100).toFixed(0)}%)</span>`).join(' ');
            contextHtml += '</small></div>';
        }

        const bgClass = isError ? 'bg-danger text-white' : 'bg-white';

        messageDiv.innerHTML = `
            <div class="d-flex align-items-start">
                <div class="avatar bg-info text-white rounded-circle me-2 d-flex align-items-center justify-content-center"
                     style="width: 36px; height: 36px; min-width: 36px;">
                    <i class="bi bi-robot"></i>
                </div>
                <div class="message-content ${bgClass} p-3 rounded shadow-sm" style="max-width: 80%;">
                    <p class="mb-0" style="white-space: pre-wrap;">${escapeHtml(text)}</p>
                    ${contextHtml}
                    ${processingTime ? `<small class="text-muted d-block mt-1"><i class="bi bi-stopwatch"></i> ${processingTime}s</small>` : ''}
                </div>
            </div>
        `;

        container.appendChild(messageDiv);
        scrollToBottom();
    }

    // Scroll chat to bottom
    function scrollToBottom() {
        const container = document.getElementById('chat-container');
        container.scrollTop = container.scrollHeight;
    }

    // Clear chat history
    async function clearChat() {
        if (!confirm('Are you sure you want to clear the chat history?')) {
            return;
        }

        try {
            const response = await fetch('{{ url_for("chatbot.clear_history") }}', {
                method: 'POST'
            });

            if (response.ok) {
                // Clear messages from UI
                document.getElementById('messages').innerHTML = '';
                OpsToolKit.showNotification('Chat history cleared', 'success', 2000);
            }
        } catch (error) {
            console.error('Error clearing chat:', error);
            OpsToolKit.showNotification('Failed to clear chat history', 'danger', 3000);
        }
    }

    // Use example question
    function askQuestion(question) {
        document.getElementById('message-input').value = question;
        document.getElementById('message-input').focus();
    }

    // HTML escape function
    function escapeHtml(text) {
        const div = document.createElement('div');
        div.textContent = text;
        return div.innerHTML;
    }

    // Auto-scroll on load
    window.addEventListener('load', scrollToBottom);
</script>
{% endblock %}
