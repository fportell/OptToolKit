{% extends "base.html" %}

{% block title %}DR-Tracker Results - OpsToolKit{% endblock %}

{% block content %}
<div class="row">
    <div class="col-12">
        <!-- Page Header -->
        <div class="d-flex justify-content-between align-items-center mb-4">
            <div>
                <h2 class="mb-2">
                    <i class="bi bi-table text-warning"></i>
                    DR-Tracker Results
                </h2>
                <p class="text-muted mb-0">
                    {% if results.status == 'completed' and results.generation_result.success %}
                        Generated {{ results.generation_result.count }} DR entries
                    {% elif results.status == 'processing' %}
                        Processing your request...
                    {% else %}
                        Generation encountered an error
                    {% endif %}
                </p>
            </div>
            <div>
                <a href="{{ url_for('dr_tracker.index') }}" class="btn btn-warning me-2">
                    <i class="bi bi-arrow-clockwise"></i> Generate More
                </a>
                <a href="{{ url_for('landing.tools') }}" class="btn btn-outline-secondary">
                    <i class="bi bi-arrow-left"></i> Back to Tools
                </a>
            </div>
        </div>

        <!-- Processing Status -->
        {% if results.status == 'processing' %}
        <div class="alert alert-info" role="alert">
            <div class="d-flex align-items-center">
                <div class="spinner-border spinner-border-sm me-3" role="status">
                    <span class="visually-hidden">Loading...</span>
                </div>
                <div>
                    <strong>Processing...</strong>
                    Your DR generation request is being processed. This page will automatically refresh when complete.
                </div>
            </div>
        </div>

        <script>
            // Auto-refresh until processing is complete
            setTimeout(function() {
                location.reload();
            }, 3000);
        </script>
        {% endif %}

        <!-- Error Display -->
        {% if results.status == 'completed' and not results.generation_result.success %}
        <div class="alert alert-danger" role="alert">
            <h5 class="alert-heading">
                <i class="bi bi-x-circle"></i> Generation Failed
            </h5>
            <p class="mb-0">
                {{ results.generation_result.error }}
            </p>
        </div>
        {% endif %}

        <!-- Success Results -->
        {% if results.status == 'completed' and results.generation_result.success %}

        <!-- Statistics Cards -->
        <div class="row mb-4">
            <div class="col-md-3">
                <div class="card border-success">
                    <div class="card-body text-center">
                        <i class="bi bi-check-circle text-success" style="font-size: 2rem;"></i>
                        <h3 class="mt-2 mb-0">{{ results.generation_result.count }}</h3>
                        <p class="text-muted mb-0">DR Entries</p>
                    </div>
                </div>
            </div>
            <div class="col-md-3">
                <div class="card border-warning">
                    <div class="card-body text-center">
                        <i class="bi bi-robot text-warning" style="font-size: 2rem;"></i>
                        <h6 class="mt-2 mb-0">{{ results.generation_result.model }}</h6>
                        <p class="text-muted mb-0 small">AI Model</p>
                    </div>
                </div>
            </div>
            <div class="col-md-3">
                <div class="card border-info">
                    <div class="card-body text-center">
                        <i class="bi bi-stopwatch text-info" style="font-size: 2rem;"></i>
                        <h5 class="mt-2 mb-0">{{ "%.1f"|format(results.generation_result.processing_time) }}s</h5>
                        <p class="text-muted mb-0 small">Processing Time</p>
                    </div>
                </div>
            </div>
            <div class="col-md-3">
                <div class="card border-primary">
                    <div class="card-body text-center">
                        <i class="bi bi-download text-primary" style="font-size: 2rem;"></i>
                        <p class="text-muted mb-2 small">Export Formats</p>
                        <div class="d-grid gap-1">
                            <a href="{{ url_for('dr_tracker.download', result_id=result_id, format='csv') }}"
                               class="btn btn-sm btn-outline-primary">
                                <i class="bi bi-file-earmark-spreadsheet"></i> CSV
                            </a>
                            <a href="{{ url_for('dr_tracker.download', result_id=result_id, format='json') }}"
                               class="btn btn-sm btn-outline-primary">
                                <i class="bi bi-filetype-json"></i> JSON
                            </a>
                            <a href="{{ url_for('dr_tracker.download', result_id=result_id, format='xlsx') }}"
                               class="btn btn-sm btn-outline-primary">
                                <i class="bi bi-file-earmark-excel"></i> XLSX
                            </a>
                        </div>
                    </div>
                </div>
            </div>
        </div>

        <!-- Validation Results -->
        {% if results.validation %}
        {% if not results.validation.valid or results.validation.warnings %}
        <div class="card mb-4 border-{% if results.validation.valid %}warning{% else %}danger{% endif %}">
            <div class="card-header bg-{% if results.validation.valid %}warning{% else %}danger{% endif %} text-{% if results.validation.valid %}dark{% else %}white{% endif %}">
                <h6 class="mb-0">
                    <i class="bi bi-{% if results.validation.valid %}exclamation-triangle{% else %}x-circle{% endif %}"></i>
                    Validation Report
                </h6>
            </div>
            <div class="card-body">
                {% if results.validation.errors %}
                <div class="mb-3">
                    <h6 class="text-danger">
                        <i class="bi bi-x-circle-fill"></i> Errors ({{ results.validation.errors|length }})
                    </h6>
                    <ul class="mb-0">
                        {% for error in results.validation.errors %}
                        <li class="text-danger">{{ error }}</li>
                        {% endfor %}
                    </ul>
                </div>
                {% endif %}

                {% if results.validation.warnings %}
                <div>
                    <h6 class="text-warning">
                        <i class="bi bi-exclamation-triangle-fill"></i> Warnings ({{ results.validation.warnings|length }})
                    </h6>
                    <ul class="mb-0">
                        {% for warning in results.validation.warnings %}
                        <li class="text-warning">{{ warning }}</li>
                        {% endfor %}
                    </ul>
                </div>
                {% endif %}
            </div>
        </div>
        {% endif %}
        {% endif %}

        <!-- DR Entries Table -->
        <div class="card shadow-sm">
            <div class="card-header bg-warning text-dark">
                <h5 class="mb-0">
                    <i class="bi bi-table"></i> Generated DR Entries
                </h5>
            </div>
            <div class="card-body p-0">
                <div class="table-responsive">
                    <table class="table table-hover table-striped mb-0">
                        <thead class="table-dark">
                            <tr>
                                <th>ID</th>
                                <th>Title</th>
                                <th>Description</th>
                                <th>Category</th>
                                <th>Priority</th>
                                <th>Status</th>
                                <th>Assigned To</th>
                                <th>Created</th>
                                <th>Due Date</th>
                            </tr>
                        </thead>
                        <tbody>
                            {% for entry in results.generation_result.entries %}
                            <tr>
                                <!-- ID -->
                                <td>
                                    <code class="text-primary">{{ entry.id }}</code>
                                </td>

                                <!-- Title -->
                                <td>
                                    <strong>{{ entry.title }}</strong>
                                </td>

                                <!-- Description -->
                                <td style="max-width: 300px;">
                                    <small>{{ entry.description }}</small>
                                </td>

                                <!-- Category -->
                                <td>
                                    <span class="badge bg-secondary">{{ entry.category }}</span>
                                </td>

                                <!-- Priority -->
                                <td>
                                    {% if entry.priority == 'High' %}
                                    <span class="badge bg-danger">
                                        <i class="bi bi-exclamation-triangle-fill"></i> High
                                    </span>
                                    {% elif entry.priority == 'Medium' %}
                                    <span class="badge bg-warning text-dark">
                                        <i class="bi bi-exclamation-circle"></i> Medium
                                    </span>
                                    {% elif entry.priority == 'Low' %}
                                    <span class="badge bg-success">
                                        <i class="bi bi-info-circle"></i> Low
                                    </span>
                                    {% else %}
                                    <span class="badge bg-secondary">{{ entry.priority }}</span>
                                    {% endif %}
                                </td>

                                <!-- Status -->
                                <td>
                                    {% if entry.status == 'Open' %}
                                    <span class="badge bg-secondary">Open</span>
                                    {% elif entry.status == 'In Progress' %}
                                    <span class="badge bg-info">In Progress</span>
                                    {% elif entry.status == 'Resolved' %}
                                    <span class="badge bg-success">Resolved</span>
                                    {% elif entry.status == 'Closed' %}
                                    <span class="badge bg-dark">Closed</span>
                                    {% else %}
                                    <span class="badge bg-secondary">{{ entry.status }}</span>
                                    {% endif %}
                                </td>

                                <!-- Assigned To -->
                                <td>
                                    {% if entry.assigned_to %}
                                    <small>{{ entry.assigned_to }}</small>
                                    {% else %}
                                    <span class="text-muted">—</span>
                                    {% endif %}
                                </td>

                                <!-- Created Date -->
                                <td>
                                    <small>{{ entry.created_date }}</small>
                                </td>

                                <!-- Due Date -->
                                <td>
                                    {% if entry.due_date %}
                                    <small>{{ entry.due_date }}</small>
                                    {% else %}
                                    <span class="text-muted">—</span>
                                    {% endif %}
                                </td>
                            </tr>
                            {% endfor %}
                        </tbody>
                    </table>
                </div>
            </div>
            <div class="card-footer text-muted">
                <small>
                    <i class="bi bi-info-circle"></i>
                    Total: {{ results.generation_result.count }} entries |
                    Scroll horizontally to see all fields
                </small>
            </div>
        </div>

        <!-- Original Prompt -->
        <div class="card mt-4">
            <div class="card-header">
                <h6 class="mb-0">
                    <i class="bi bi-chat-left-text"></i> Original Prompt
                </h6>
            </div>
            <div class="card-body">
                <pre class="mb-0" style="white-space: pre-wrap; font-family: inherit;">{{ results.generation_result.prompt }}</pre>
            </div>
        </div>

        {% endif %}
    </div>
</div>
{% endblock %}

{% block extra_css %}
<style>
    /* Make table horizontally scrollable on small screens */
    .table-responsive {
        overflow-x: auto;
    }

    /* Ensure table doesn't get too squished */
    .table-responsive table {
        min-width: 1200px;
    }
</style>
{% endblock %}
